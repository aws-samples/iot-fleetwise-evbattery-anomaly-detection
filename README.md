# iot-fleetwise-evbattery-anomaly-detection

This project contains the following separate CDK projects, 
- L2 CDK construct to provision AWS IoT Fleetwise for an EV fleet. 
- Vehicle Simulator using ECS to simulate vehicle telemetry into FleetWise
- IoT Twinmaker and Grafana dashbaord for visualization of the telemetry data

# Install

```sh
npm install iot-fleetwise-evbattery-anomaly-detection
```

## Getting started with FleetWise CDK stack
To deploy a simple end-to-end example you can use the following commands

```sh
yarn install
projen && projen compile
npx cdk -a lib/integ.full.js deploy -c key_name=mykey
```

Where `mykey` is an existing keypair name present in your account.
The deploy takes about 15 mins mostly due to compilation of the IoT FleetWise agent in the
EC2 instance that simulate the vehicle. Once deploy is finshed, data will start to show up in your Timestream table.

## Getting started with Vehicle Simulator CDK stack
This package contains the Cloud Development Kit (CDK) classes that define all the native AWS resources associated with FleetWise Vehicle Simulator. These classes are written in TypeScript, a statically-bound language based off of JavaScript. The build system is Node, by way of an internal Amazon wrapper called "NpmPrettyMuch".

When this package is built, it produces a set of CloudFormation templates in the ./build/cdk.out directory, one for each of the CloudFormation stacks the package defines in its CDK App. You can deploy these CloudFormation templates to your AWS Account using the CDK Toolkit, which is included in this package, as explained below.

## AWS Resources 
This CDK App spins up 2 CloudFormation stacks when deployed to your developer account, plus a few for bootstrapping/resources needed by Builder Tools systems.

ECS Cluster Stack. This stack includes the 1) vpc with maximum 3 AZs. 2) Security Group. 3) EC2 Launch Template. 4) EC2 ASG. 5) ECS Cluster and capacity provider
ECS Task Stack. This contains the task definition to perform Edge agent simulation and output logs to cloudwatch
We de-couple ECS task stack from cluster stack to allow developer create their own task stack and reuse the same cluster. ECS Image Updater Stack is only required for enabling EC2 OS auto update which provides security assurance on long run EC2 instances.

A quick tour of this package's contents
./lib/app.ts - This is a TypeScript file in which we instantiate CDK stacks and associate them with our App. This App doesn't generate AWS pipeline. It's intended to be used for local testing.
./lib/ecs-cluster.ts - This script is used to create AWS resources for ECS Cluster
./lib/ecs-task.ts - This script is used to create AWS resources for ECS Task
./lib/ec2-image-updater.ts - This script creates Image Builder Pipeline which periodically check if there's new update from Ubuntu.
./lib/ec2-image-updater.yaml - The yaml file comes from AWS ECS auto update reference on GitHub.
./lib/ec2-setup-scripts/al2-kernel-5/ec2-ami-setup.sh - Bash script for User Data section of Image Builder Component used to build custom EC2 Image with Amazon Linux 2 Kernel 5.10
./lib/ec2-setup-scripts/al2-kernel-5/ec2-launch-with-custom-ami.sh - Bash script for User Data section of EC2 launching with custom AMI generated by Image Build Pipeline above
./lib/ec2-setup-scripts/ubuntu-20-lts/ec2-ami-setup.sh - Bash script for User Data section of Image Builder Component used to build custom EC2 Image with Ubuntu 20.04
./lib/ec2-setup-scripts/ubuntu-20-lts/ec2-launch-with-custom-ami.sh - Bash script for User Data section of EC2 launching with custom AMI generated by Image Build Pipeline above
./lib/ec2-install-chronicle.ts - This script export function to install Chronicle. It currently only support Amazon Linux 2.
./lib/LifecycleLaunchLambda/index.py - AWS Lambda function source code to handle ECS EC2 instance launch activity.
./lib/LifecycleTerminateLambda/index.py - AWS Lambda function source code to handle ECS EC2 instance terminate activity.

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more 
information.

## License

This code is licensed under the MIT-0 License. See the LICENSE file.
